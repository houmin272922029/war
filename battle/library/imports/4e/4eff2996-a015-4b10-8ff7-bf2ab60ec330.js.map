{"version":3,"sources":["..\\..\\..\\..\\..\\..\\assets\\script\\framework\\manager/assets\\script\\framework\\manager\\AudioManager.js"],"names":["ConfigManager","require","AudioManager","bgsid","effects","effectList","isLoad","musicVolume","effectVolume","musicClose","effectClose","init","str","cc","sys","localStorage","getItem","isValid","parseFloat","parseInt","log","info","_covertToValidUrl","url","callback","indexOf","loader","loadRes","AudioClip","err","clip","error","message","playMusic","musicName","getUrlByName","stopMusic","audioEngine","play","_getMusicVolue","bgClip","stop","uncache","releaseAsset","releaseEffect","sid","playEffect","effectName","canBreak","_getEffectVolume","breakEffect","setFinishCallback","playEffectSpecial","stopAllEffects","setEffectVolume","v","isSave","setVolume","setItem","setMusicVolume","setMusicClose","setEffectClose","resumeMusicEffect","musicV","effectV","name","cfg","dataMap","Music","ret","cfgArr","split","random","Math","index","floor","length","module","exports"],"mappings":"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","file":"AudioManager.js","sourceRoot":"..\\..\\..\\..\\..\\..\\assets\\script\\framework\\manager","sourcesContent":["const ConfigManager = require('ConfigManager');\r\n\r\nlet AudioManager = {\r\n    bgsid: -1,\r\n    effects: {},\r\n    effectList: {},\r\n    isLoad: false,\r\n\r\n    musicVolume: 1,\r\n    effectVolume: 1,\r\n    musicClose: false,\r\n    effectClose: false,\r\n\r\n    init() {\r\n        if (!this.isLoad) {\r\n            let str = cc.sys.localStorage.getItem('musicVolume');\r\n            if (!cc.isValid(str) || str == \"\") {\r\n                str = '0';\r\n            }\r\n            this.musicVolume = 1 - parseFloat(str);\r\n\r\n            str = cc.sys.localStorage.getItem('effectVolume');\r\n            if (!cc.isValid(str) || str == \"\") {\r\n                str = '0';\r\n            }\r\n            this.effectVolume = 1 - parseFloat(str);\r\n\r\n            str = cc.sys.localStorage.getItem('musicClose');\r\n            if (!cc.isValid(str) || str == \"\") {\r\n                str = '1';\r\n            }\r\n            this.musicClose = 1 - parseInt(str);\r\n\r\n            str = cc.sys.localStorage.getItem('effectClose');\r\n            if (!cc.isValid(str) || str == \"\") {\r\n                str = '1';\r\n            }\r\n            this.effectClose = 1 - parseInt(str);\r\n\r\n            this.isLoad = true;\r\n            log.info('AudioManager init = {}, {}', this.musicVolume, this.effectVolume);\r\n        }\r\n    },\r\n\r\n    _covertToValidUrl(url, callback) {\r\n        if ('string' == typeof url) {\r\n            if (url.indexOf('audio/') < 0) {\r\n                url = 'audio/' + url;\r\n            }\r\n            cc.loader.loadRes(url, cc.AudioClip, (err, clip) => {\r\n                // if (url.indexOf('.mp3') < 0) {\r\n                //     url += '.mp3'; //'.ogg';\r\n                // }\r\n                if (!err) {\r\n                    callback(clip);\r\n                } else {\r\n                    log.error('load clip failed = {}', err.message);\r\n                }\r\n            });\r\n        } else {\r\n            callback(url);\r\n        }\r\n        // return url;\r\n    },\r\n\r\n    playMusic(musicName) {\r\n        let url = this.getUrlByName(musicName);\r\n        if (!url) return;\r\n        this.init();\r\n        this._covertToValidUrl('music/' + url, (clip) => {\r\n            // log.info('playMusic = {}', clip);\r\n            this.stopMusic();\r\n            this.bgsid = cc.audioEngine.play(clip, true, this._getMusicVolue());\r\n            this.bgClip = clip;\r\n        });\r\n\r\n    },\r\n\r\n    stopMusic() {\r\n        cc.audioEngine.stop(this.bgsid);\r\n        if (this.bgClip) cc.audioEngine.uncache(this.bgClip);\r\n        if (this.bgClip) cc.loader.releaseAsset(this.bgClip);\r\n        this.bgsid = -1;\r\n    },\r\n\r\n    releaseEffect(sid) {\r\n        let clip = this.effects[sid];\r\n        // cc.audioEngine.stop(sid);\r\n        if (clip) cc.audioEngine.uncache(clip);\r\n        if (clip) cc.loader.releaseAsset(clip);\r\n        delete this.effects[sid];\r\n    },\r\n\r\n    playEffect(effectName, canBreak) {\r\n        let url = this.getUrlByName(effectName);\r\n\r\n        if (!url || this._getEffectVolume() == 0) {\r\n            return;\r\n        }\r\n\r\n        this.init();\r\n        if (this.breakEffect) {\r\n            this.releaseEffect(this.breakEffect);\r\n            this.breakEffect = null;\r\n        }\r\n\r\n        this._covertToValidUrl('effect/' + url, (clip) => {\r\n            let sid = cc.audioEngine.play(clip, false, this._getEffectVolume());\r\n            if (canBreak) this.breakEffect = sid;\r\n            this.effects[sid] = clip;\r\n            cc.audioEngine.setFinishCallback(sid, () => {\r\n                // this.releaseEffect(sid);\r\n            });\r\n        });\r\n    },\r\n\r\n    playEffectSpecial(effectName, canBreak) {\r\n        let url = this.getUrlByName(effectName);\r\n\r\n        if (!url || this.effectList[url]) {\r\n            return;\r\n        }\r\n\r\n        this.init();\r\n        if (this.breakEffect) {\r\n            this.releaseEffect(this.breakEffect);\r\n            this.breakEffect = null;\r\n        }\r\n\r\n        this._covertToValidUrl('effect/' + url, (clip) => {\r\n            this.effectList[url] = true;\r\n            let sid = cc.audioEngine.play(clip, false, this._getEffectVolume());\r\n            if (canBreak) this.breakEffect = sid;\r\n            this.effects[sid] = clip;\r\n            cc.audioEngine.setFinishCallback(sid, () => {\r\n                this.effectList[url] = false;\r\n                this.releaseEffect(sid);\r\n            });\r\n        });\r\n    },\r\n\r\n    stopAllEffects() {\r\n        for (let sid in this.effects) {\r\n            cc.audioEngine.stop(sid);\r\n            cc.audioEngine.uncache(this.effects[sid]);\r\n            delete this.effects[sid];\r\n        }\r\n    },\r\n\r\n    setEffectVolume(v, isSave) {\r\n        this.effectVolume = v;\r\n        for (let sid in this.effects) {\r\n            cc.audioEngine.setVolume(sid, this._getEffectVolume());\r\n        }\r\n        if (isSave) {\r\n            // log.info('AudioManager setEffectVolume : {}', 1 - this.effectVolume);\r\n            cc.sys.localStorage.setItem('effectVolume', 1 - this.effectVolume);\r\n        }\r\n    },\r\n\r\n    _getEffectVolume() {\r\n        // log.info('_getEffectVolume close : {}, volume : {}', this.effectClose, this.effectVolume);\r\n        if (this.effectClose)\r\n            return 0;\r\n\r\n        return this.effectVolume;\r\n    },\r\n\r\n    setMusicVolume(v, isSave) {\r\n        this.musicVolume = v;\r\n        cc.audioEngine.setVolume(this.bgsid, this._getMusicVolue());\r\n        if (isSave) {\r\n            // log.info('AudioManager setMusicVolume : {}', 1 - this.musicVolume);\r\n            cc.sys.localStorage.setItem('musicVolume', 1 - this.musicVolume);\r\n        }\r\n    },\r\n\r\n    _getMusicVolue() {\r\n        if (this.musicClose)\r\n            return 0;\r\n\r\n        return this.musicVolume;\r\n    },\r\n\r\n    setMusicClose(v) {\r\n        this.musicClose = v ? 1 : 0;\r\n        cc.audioEngine.setVolume(this.bgsid, this._getMusicVolue());\r\n        cc.sys.localStorage.setItem('musicClose', 1 - this.musicClose);\r\n    },\r\n\r\n    setEffectClose(v) {\r\n        this.effectClose = v ? 1 : 0;\r\n        for (let sid in this.effects) {\r\n            cc.audioEngine.setVolume(sid, this._getEffectVolume());\r\n        }\r\n        cc.sys.localStorage.setItem('effectClose', 1 - this.effectClose);\r\n    },\r\n\r\n    resumeMusicEffect() {\r\n        let musicV = this._getMusicVolue();\r\n        this.setMusicVolume(musicV, true);\r\n        let effectV = this._getEffectVolume();\r\n        this.setEffectVolume(effectV, true);\r\n    },\r\n\r\n    //获取音效资源\r\n    getUrlByName: function (name) {\r\n        let cfg = ConfigManager.dataMap.Music[name];\r\n        if (!cfg) {\r\n            return null;\r\n        }\r\n        let ret;\r\n        if (cfg.indexOf(',') == -1) {\r\n            ret = cfg;\r\n        } else {\r\n            let cfgArr = cfg.split(',');\r\n            let random = Math.random();\r\n            let index = Math.floor(random * cfgArr.length);\r\n            ret = cfgArr[index];\r\n        }\r\n        return ret;\r\n    },\r\n}\r\n\r\nmodule.exports = AudioManager;\r\n"]}