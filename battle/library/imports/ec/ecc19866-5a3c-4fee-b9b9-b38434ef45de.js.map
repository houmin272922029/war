{"version":3,"sources":["..\\..\\..\\..\\..\\..\\assets\\script\\framework\\manager/assets\\script\\framework\\manager\\SpriteManager.js"],"names":["module","exports","inited","dirs","weekCard","path","isPreload","head","shop","icon","vip","vipreward","common","arena","mainCommon","mainBg","fishIcon","bless","vipWeapon","handBook","bulletAndNet","treasureFish","match","bill","init","callback","log","info","keys","Object","i","len","length","dir","value","frames","isStatic","loadDir","progressCallback","completeCallback","cc","loader","loadResDir","SpriteFrame","err","objects","error","message","name","frame","ref","setSprite","node","warn","sp","getComponent","Sprite","addComponent","load","obj","spriteFrame","createSprite","parent","Node","object","addChild","_getFrame","_getPath","config","loadRes","removeIndex","release","deps","getDependsRecursively","releaseDir","releaseScene","str","indexOf","_cacheFrame","_modifyDestroy","self","oldDestroy","onDestroy","_releaseFrame","call","setTimeout","_fullPath","url","raw","_simplifyPath","index","substring"],"mappings":"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","file":"SpriteManager.js","sourceRoot":"..\\..\\..\\..\\..\\..\\assets\\script\\framework\\manager","sourcesContent":["\r\n/**\r\n *  游戏内纹理管理（全局纹理以及临时纹理）\r\n */\r\n\r\nmodule.exports = {\r\n    inited: false,\r\n    /**\r\n     * 必需参数 path: 资源相对路径。\r\n     * 可选参数 isStatic: 是否为全局静态资源(游戏启动时加载，一直保存在内存中)\r\n     * 可选参数 isPreload: 是否需预加载(进入场景时加载，本场景内有效)\r\n     */\r\n    dirs: {\r\n        // 公共\r\n        weekCard: { path: 'texture/weekCard/', isPreload: false },\r\n        head: { path: 'texture/personal/' },\r\n        shop: { path: 'texture/shop/' },\r\n        icon: { path: 'texture/icon/' },\r\n        vip: { path: 'texture/vip/' },\r\n        vipreward: { path: 'texture/vipreward/' },\r\n        common: { path: 'texture/common/' },\r\n        // 大厅\r\n        arena:{path: 'texture/hall/arena/' },\r\n        // 渔场\r\n        mainCommon: { path: 'texture/mainScene/common/' },\r\n        mainBg: { path: 'texture/mainScene/bg/' },\r\n        fishIcon:  { path: 'texture/mainScene/fishIcon/' },\r\n        bless: { path: 'texture/mainScene/bless/' },\r\n        vipWeapon: { path: 'texture/mainScene/vipWeapon/' },\r\n        handBook: { path: 'texture/mainScene/handbook/' },\r\n        bulletAndNet: {path: 'texture/mainScene/bulletAndNet/' },\r\n        treasureFish: {path: 'texture/mainScene/treasureFish/' },\r\n        match: {path: 'texture/mainScene/match/' },\r\n        bill: {path: 'texture/hall/bill/' },\r\n    },\r\n\r\n\r\n    init: function(callback) {\r\n        if (this.inited) {\r\n            log.info('SpriteManager.init: has been called');\r\n        } else {\r\n            this.inited = true;\r\n            let keys = Object.keys(this.dirs);\r\n            for (let i = 0, len = keys.length; i < len; i++) {\r\n                let dir = keys[i];\r\n                let value = this.dirs[dir];\r\n                value.frames = {}; // 初始化缓存池\r\n                if (!!value.isStatic && value.isStatic === true) {\r\n                    this.loadDir(dir);\r\n                }\r\n            }\r\n        }\r\n        callback && callback();\r\n    },\r\n\r\n    // 加载一个sprite目录\r\n    // progressCallback - 可选参数，加载过程中的回调，可不填\r\n    loadDir: function(dir, progressCallback, completeCallback) {\r\n        if (void 0 === completeCallback) {\r\n            completeCallback = progressCallback;\r\n            progressCallback = null;\r\n        }\r\n        let value = this.dirs[dir];\r\n        let path = value.path;\r\n        // 加载整个目录\r\n        cc.loader.loadResDir(path, cc.SpriteFrame, progressCallback, (err, objects) => {\r\n            if (err) {\r\n                log.error('SpriteManager.loadDir: error path: ' +path +', ' +err||err.message);\r\n            } else {\r\n                // log.info('SpriteManager.loadDir: success path: ' +path);\r\n                for (let i in objects) {\r\n                    value.frames[objects[i].name] = {frame:objects[i], ref:1};\r\n                }\r\n            }\r\n            // 不管成功或失败，都要执行完成回调\r\n            !!completeCallback && completeCallback();\r\n        });\r\n    },\r\n\r\n    /**\r\n     * 设置图片\r\n     * @param {*Sprite的Node节点} node\r\n     * @param {*dir} 静态资源类别（替代路径）\r\n     * @param {*name} 资源名（xxx.png）\r\n     * @param {*callback} 回调函数\r\n     */\r\n    setSprite: function(node, dir, name, callback) {\r\n        if (!node || !dir || !name) {\r\n            log.warn('setSprite: param is invalid. dir={}, name={}', dir, name);\r\n            return null;\r\n        }\r\n        let sp = node.getComponent(cc.Sprite);\r\n        if (!sp) {\r\n            sp = node.addComponent(cc.Sprite);\r\n        }\r\n        this.load(dir, name, (obj) => {\r\n            sp.spriteFrame = obj.frame;\r\n            // this._cacheFrame(sp, obj, dir, name); // 缓存计数\r\n            !!callback && callback(obj.frame);\r\n        });\r\n        return sp;\r\n    },\r\n\r\n    // 动态创建Sprite节点\r\n    createSprite: function(parent, dir, name, callback) {\r\n        let node = new cc.Node();\r\n        node.addComponent(cc.Sprite);\r\n        this.setSprite(node, dir, name, (object) => {\r\n            parent.addChild(node);\r\n            !!callback && callback(node, object);\r\n        });\r\n    },\r\n\r\n    // 返回缓存的frame对象，注意：不是SpriteFrame\r\n    _getFrame: function(dir, name) {\r\n        let value = this.dirs[dir];\r\n        if (!!value && !!value.frames && !!value.frames[name]) {\r\n            return value.frames[name];\r\n        }\r\n        return null;\r\n    },\r\n\r\n    _getPath: function(dir, name) {\r\n        let value = this.dirs[dir];\r\n        return (value.path + name);\r\n    },\r\n\r\n    /**\r\n     * 动态加载图片\r\n     * @param {*Sprite的Node节点} node\r\n     * @param {*path} 资源路径\r\n     */\r\n    load: function(dir, name, callback, config) {\r\n        // 首先查找缓存\r\n        let obj = this._getFrame(dir, name);\r\n        if (obj) {\r\n            !!callback && callback(obj);\r\n            return;\r\n        }\r\n\r\n        // 未找到缓存，执行异步加载\r\n        let value = this.dirs[dir];\r\n        let path = value.path + name;\r\n        cc.loader.loadRes(path, cc.SpriteFrame, (err, object) => {\r\n            if (err || !object) {\r\n                log.error('SpriteManager.load: error path: ' +path + ', ' +err||err.message);\r\n                return;\r\n            }\r\n            // if (!!config && !!config.cache) {\r\n            //     // todo\r\n            // } else {\r\n            //     // 默认设置为场景切换时自动释放该SpriteFrame和它引用的贴图资源\r\n            //     cc.loader.setAutoReleaseRecursively(object, true);\r\n            // }\r\n            value.frames[object.name] = {frame:object, ref:0};\r\n            !!callback && callback(value.frames[object.name]);\r\n        });\r\n    },\r\n\r\n    // 删除一个缓存索引\r\n    removeIndex: function(dir, name) {\r\n        let value = this.dirs[dir];\r\n        if (!!value && !!value.frames && !!value.frames[name]) {\r\n            delete value.frames[name];\r\n        }\r\n    },\r\n\r\n    // 释放一个SpriteFrame资源\r\n    release: function(dir, name) {\r\n        let obj = this._getFrame(dir, name);\r\n        if (obj) {\r\n            this.removeIndex(dir, name);\r\n            let deps = cc.loader.getDependsRecursively(obj.frame);\r\n            if (deps) {\r\n                cc.loader.release(deps); // 立即释放SpriteFrame和它引用的贴图资源\r\n                // log.info('SpriteManager.release: dir={}, name={}', dir, name);\r\n            }\r\n        }\r\n    },\r\n\r\n    // 释放整个目录下的资源(包括索引缓存和实际引用资源)\r\n    releaseDir: function(dir) {\r\n        let value = this.dirs[dir];\r\n        if (!!value && !!value.frames) {\r\n            for (let i in value.frames) {\r\n                this.release(dir, i);\r\n            }\r\n            value.frames = {};\r\n        }\r\n    },\r\n\r\n    // 释放指定场景的所有资源\r\n    releaseScene: function(name) {\r\n        let str = '/' + name + '/';\r\n        let keys = Object.keys(this.dirs);\r\n        for (let i = 0, len = keys.length; i < len; i++) {\r\n            let dir = keys[i];\r\n            let value = this.dirs[dir];\r\n            if (value.path.indexOf(str) >= 0) {\r\n                this.releaseDir(dir);\r\n            }\r\n        }\r\n    },\r\n\r\n    _cacheFrame: function(sp, obj, dir, name) {\r\n        if (!!obj) {\r\n            if (obj.ref < 1) {\r\n                this._modifyDestroy(sp, obj, dir, name);// 覆盖onDestroy，自动释放\r\n            }\r\n            obj.ref++;\r\n        }\r\n    },\r\n\r\n    // 首次动态换图修改destroy\r\n    _modifyDestroy: function(sp, obj, dir, name) {\r\n        if (!sp || !obj || !dir || !name) {\r\n            return;\r\n        }\r\n        let self = this;\r\n        let oldDestroy = sp.onDestroy;\r\n        sp.onDestroy = function() {\r\n            self._releaseFrame(dir, name);\r\n            if (oldDestroy) {\r\n                oldDestroy.call(this);\r\n            }\r\n        };\r\n    },\r\n\r\n    // 如果引用计数为0，则实际释放资源\r\n    _releaseFrame: function(dir, name) {\r\n        let self = this;\r\n        let obj = this._getFrame(dir, name);\r\n        if (obj) {\r\n            obj.ref--;\r\n            if (obj.ref < 1) {\r\n                obj.ref = 0;\r\n                log.info('SpriteManager._releaseFrame: dir={}, name={}', dir, name);\r\n                setTimeout(()=>{\r\n                    self.release(dir, name);\r\n                }, 0); // 下一帧释放\r\n            }\r\n        }\r\n    },\r\n\r\n    _fullPath: function (url) {\r\n        let path = '';\r\n        if (url.indexOf('resources/') < 0) {\r\n            path = 'resources/' + url;\r\n        }\r\n        if (url.indexOf('.png') < 0) {\r\n            path += '.png';\r\n        }\r\n        if (url.indexOf('assets/') < 0) {\r\n            path = cc.url.raw(path);\r\n        }\r\n        return path;\r\n    },\r\n\r\n    _simplifyPath: function (url) {\r\n        let path = '';\r\n        let index = url.indexOf('assets/');\r\n        if (index >= 0) {\r\n            path = url.substring(index + 7);\r\n        }\r\n        index = path.indexOf('resources/');\r\n        if (index >= 0) {\r\n            path = path.substring(index + 10);\r\n        }\r\n        index = path.indexOf('.png');\r\n        if (index >= 0) {\r\n            path = path.substring(0, path.length - 4);\r\n        }\r\n        index = path.indexOf('.jpg');\r\n        if (index >= 0) {\r\n            path = path.substring(0, path.length - 4);\r\n        }\r\n        return path;\r\n    }\r\n};\r\n"]}