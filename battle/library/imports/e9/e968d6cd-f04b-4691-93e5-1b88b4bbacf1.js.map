{"version":3,"sources":["..\\..\\..\\..\\..\\..\\assets\\script\\framework\\manager/assets\\script\\framework\\manager\\PrefabManager.js"],"names":["NetLoaderManager","require","PrefabManager","inited","dirs","init","callback","self","log","info","keys","Object","i","len","length","dir","value","prefabs","isStatic","loadDir","progressCallback","completeCallback","cc","loader","loadResDir","path","Prefab","err","objects","status","error","name","load","config","object","getPrefab","loadRes","closeCheckStatus","startCheckStatus","fullPath","warn","removeIndex","release","obj","deps","getDependsRecursively","releaseDir","releaseScene","str","indexOf","createInstance","root","category","idx","prefab","instantiate","parent","module","exports"],"mappings":"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","file":"PrefabManager.js","sourceRoot":"..\\..\\..\\..\\..\\..\\assets\\script\\framework\\manager","sourcesContent":["const NetLoaderManager = require('NetLoaderManager');\r\n\r\n/**\r\n * 全局预制体管理类\r\n */\r\nlet PrefabManager = {\r\n    inited: false,\r\n    \r\n\r\n    dirs: {\r\n        // first: { path: 'prefab/first/', isStatic: true },\r\n        // common: { path: 'prefab/common/', isPreload: false },\r\n        // //登陆\r\n        // login: { path: 'prefab/login/', isPreload: false },\r\n        // // 大厅\r\n        // hallCommon: { path: 'prefab/hall/common/', isPreload: true },\r\n        // hallArena: { path: 'prefab/hall/arena/', isPreload: true },\r\n        // weekCard: { path: 'prefab/hall/weekCard/', isPreload: true },\r\n        // shop: { path: 'prefab/hall/shop/', isPreload: true },\r\n        // vip: { path: 'prefab/hall/vip/', isPreload: true },\r\n        // signin: { path: 'prefab/hall/signin/', isPreload: true },\r\n        // mail: { path: 'prefab/hall/mail/', isPreload: false },\r\n        // bag: { path: 'prefab/hall/bag/', isPreload: false },\r\n        // personal: { path: 'prefab/hall/personal/', isPreload: true },\r\n        // bill: { path: 'prefab/bill/', isPreload: false },\r\n        // sevenday: { path: 'prefab/hall/sevenday/', isPreload: true },\r\n\r\n        // // 主渔场\r\n        // mainPreload: { path: 'prefab/mainScene/preload/', isPreload: true },\r\n        // mainCommon: { path: 'prefab/mainScene/common/', isPreload: true },\r\n        // weapon: { path: 'prefab/mainScene/weapon/', isPreload: true },\r\n        // skill: { path: 'prefab/mainScene/skill/', isPreload: true },\r\n        // tip: { path: 'prefab/mainScene/tip/' },\r\n        // bless: { path: 'prefab/mainScene/bless/', isPreload: true },\r\n        // palace: { path: 'prefab/mainScene/palace/', isPreload: true },\r\n        // debug: { path: 'prefab/mainScene/debug/' },\r\n        // arena: { path: 'prefab/mainScene/arena/' },\r\n        // task: { path: 'prefab/mainScene/task/' },\r\n        // buttonCom: { path: 'prefab/mainScene/buttonCom/' },\r\n        // treasureHuntFish: { path: 'prefab/mainScene/treasureHuntFish/', isPreload: true },\r\n        // match: { path: 'prefab/mainScene/match/' },\r\n        // fish: { path: 'fish/prefab/', isPreload: true },\r\n    },\r\n\r\n    init: function (callback) {\r\n        let self = this;\r\n        if (self.inited) {\r\n            log.info('PrefabManager.init: has been called');\r\n            callback && callback();\r\n            return;\r\n        }\r\n        self.inited = true;\r\n\r\n        let keys = Object.keys(this.dirs);\r\n        for (let i = 0, len = keys.length; i < len; i++) {\r\n            let dir = keys[i];\r\n            let value = this.dirs[dir];\r\n            value.prefabs = {};\r\n            if (!!value.isStatic && value.isStatic === true) {\r\n                this.loadDir(dir);\r\n            }\r\n        }\r\n        callback && callback();\r\n    },\r\n\r\n    // 加载一个prefab目录\r\n    // progressCallback - 过程中回调，可跳过直接填完成回调\r\n    loadDir: function (dir, progressCallback, completeCallback) {\r\n        if (void 0 === completeCallback) {\r\n            completeCallback = progressCallback;\r\n            progressCallback = null;\r\n        }\r\n        let value = this.dirs[dir];\r\n        // 加载整个目录\r\n        cc.loader.loadResDir(value.path, cc.Prefab, progressCallback, (err, objects) => {\r\n            if (err && err.status) {\r\n                log.error('PrefabManager.loadDir: error path = {}, err = {}', value.path, err);\r\n            } else {\r\n                for (let i in objects) {\r\n                    value.prefabs[objects[i].name] = objects[i];\r\n                }\r\n            }\r\n            // 不管成功或失败，都要执行回调\r\n            completeCallback && completeCallback();\r\n        });\r\n    },\r\n\r\n    // 加载一个prefab文件\r\n    // callback - 可选参数。加载完成后执行回调\r\n    // config - 可选参数。附加选项\r\n    load: function (dir, name, callback, config) {\r\n        let object = this.getPrefab(dir, name);\r\n        if (object) {\r\n            // 在缓存中找到\r\n            !!callback && callback(object);\r\n            return;\r\n        }\r\n\r\n        // 未找到，执行异步加载\r\n        let value = this.dirs[dir];\r\n        let path = value.path + name;\r\n        cc.loader.loadRes(path, cc.Prefab, (err, object) => {\r\n            if (err && err.status || !object) {\r\n                log.error('PrefabManager._load: error path = {}, err = {}', path, err);\r\n                return;\r\n            }\r\n            value.prefabs[object.name] = object; // 置缓存\r\n            !!callback && callback(object);\r\n            NetLoaderManager.closeCheckStatus(object);\r\n            // cc.loader.setAutoReleaseRecursively(object, true);\r\n        });\r\n        NetLoaderManager.startCheckStatus(path);\r\n    },\r\n\r\n    // 返回完整路径\r\n    fullPath: function (dir, name) {\r\n        let path = '';\r\n        let value = this.dirs[dir];\r\n        if (!value) {\r\n            log.warn('PrefabManager.fullPath: error dir={}, name={}', dir, name);\r\n            return path;\r\n        }\r\n        path = value.path + name;\r\n        return path;\r\n    },\r\n\r\n    getPrefab: function (dir, name) {\r\n        let value = this.dirs[dir];\r\n        if (!!value && !!value.prefabs && value.prefabs[name]) {\r\n            return value.prefabs[name];\r\n        }\r\n        return false;\r\n    },\r\n\r\n    // 删除一个缓存索引\r\n    removeIndex: function (dir, name) {\r\n        let value = this.dirs[dir];\r\n        if (!!value && !!value.prefabs && value.prefabs[name]) {\r\n            delete value.prefabs[name];\r\n        }\r\n    },\r\n\r\n    // 释放一个Prefab资源\r\n    release: function (dir, name) {\r\n        let obj = this.getPrefab(dir, name);\r\n        if (obj) {\r\n            this.removeIndex(dir, name);\r\n            let deps = cc.loader.getDependsRecursively(obj);\r\n            if (deps) {\r\n                cc.loader.release(deps);\r\n                // log.info('PrefabManager.release: dir={}, name={}', dir, name);\r\n            }\r\n        }\r\n    },\r\n\r\n    // 释放整个目录下的资源(包括索引缓存和实际引用资源)\r\n    releaseDir: function (dir) {\r\n        let value = this.dirs[dir];\r\n        if (value && !!value.prefabs) {\r\n            for (let i in value.prefabs) {\r\n                this.release(dir, i);\r\n            }\r\n            value.prefabs = {};\r\n        }\r\n    },\r\n\r\n    // 释放指定场景的所有资源\r\n    releaseScene: function (name) {\r\n        let str = '/' + name + '/';\r\n        let keys = Object.keys(this.dirs);\r\n        for (let i = 0, len = keys.length; i < len; i++) {\r\n            let dir = keys[i];\r\n            let value = this.dirs[dir];\r\n            if (value.path.indexOf(str) >= 0) {\r\n                this.releaseDir(dir);\r\n            }\r\n        }\r\n    },\r\n\r\n    /**\r\n     * root prefab 预制件父节点\r\n     * category 预制件 key\r\n     * idx      预制件名\r\n     */\r\n    createInstance: function (root, category, idx) {\r\n        if (!root) {\r\n            log.info('PrefabManager createInstance root in null');\r\n            return;\r\n        }\r\n        let prefab = this.getPrefab(category, idx);\r\n        if (prefab) {\r\n            let obj = cc.instantiate(prefab);\r\n            obj.parent = root;\r\n            return obj;\r\n        }\r\n    }\r\n}\r\n\r\nmodule.exports = PrefabManager;\r\n"]}