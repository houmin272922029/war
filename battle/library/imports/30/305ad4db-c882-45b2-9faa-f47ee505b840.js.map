{"version":3,"sources":["..\\..\\..\\..\\..\\..\\assets\\script\\framework\\hotupdate/assets\\script\\framework\\hotupdate\\CheckVersion.js"],"names":["i18n","require","Checker","URL","downloadData","url","callback","xhr","cc","loader","getXMLHttpRequest","timedout","timer","setTimeout","abort","onreadystatechange","clearInterval","readyState","status","responseText","open","send","check","manifest","log","info","load","err","asset","js","JSON","parse","remoteVersionUrl","remoteManifestUrl","localVersion","version","localBigVer","split","find","getComponent","Label","string","result","remoteVersion","remoteBigVer","show","text","t","formatList","type","yesCB","removePaths","sys","localStorage","getItem","arr","i","jsb","fileUtils","removeDirectory","openURL","packageUrl","game","end","noCB","module","exports"],"mappings":"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","file":"CheckVersion.js","sourceRoot":"..\\..\\..\\..\\..\\..\\assets\\script\\framework\\hotupdate","sourcesContent":["let i18n = require('LanguageData');\r\n\r\nlet Checker = {\r\n    // URL_ANDROID : '818Android.html',\r\n    // URL_IOS : '818iOS.html',\r\n    URL: '818.html',\r\n};\r\n\r\nfunction downloadData(url, callback) {\r\n    var xhr = cc.loader.getXMLHttpRequest();\r\n    var timedout = false;\r\n    var timer = setTimeout(function () {\r\n        timedout = true;\r\n        xhr.abort();\r\n        // require('NetCore').showReconnect();\r\n    }, 10000);\r\n    xhr.onreadystatechange = function () {\r\n        if (timedout) { return; }\r\n        clearInterval(timer);\r\n        if (xhr.readyState == 4 && (xhr.status >= 200 && xhr.status < 400)) {\r\n            if (callback) { callback(true, xhr.responseText); }\r\n        } else {\r\n            if (callback) { callback(false); }\r\n        }\r\n    };\r\n    xhr.open(\"GET\", url, true);\r\n    xhr.send();\r\n};\r\n\r\n/**\r\n * 检测是否有大版本更新\r\n */\r\nChecker.check = function (manifest, callback) {\r\n    log.info('manifest : ' + manifest);\r\n    cc.loader.load(manifest, function (err, asset) {\r\n        if (err) {\r\n            log.info('Checker load manifest failed : ' + manifest);\r\n            return;\r\n        }\r\n\r\n        let js = JSON.parse(asset);\r\n        let remoteVersionUrl = js.remoteManifestUrl;\r\n        let localVersion = js.version;\r\n        let localBigVer = localVersion.split('.')[0];\r\n        log.info('local version : ' + localVersion + ', big : ' + localBigVer);\r\n\r\n        cc.find('Canvas/version').getComponent(cc.Label).string = 'Version:' + localVersion;\r\n\r\n        downloadData(remoteVersionUrl, function (result, asset) {\r\n            if (result) {\r\n                let js = JSON.parse(asset);\r\n                let remoteVersion = js.version;\r\n                let remoteBigVer = remoteVersion.split('.')[0];\r\n                log.info('remote version : ' + remoteVersion + ', big : ' + remoteBigVer);\r\n                if (localBigVer <= remoteBigVer) {\r\n                    require('UIMessageBox').show(\r\n                        {\r\n                            text: i18n.t(17).formatList(localVersion, remoteVersion),\r\n                            type: 1,\r\n                            yesCB: function () {\r\n                                var removePaths = cc.sys.localStorage.getItem('RemotePaths');\r\n                                // 删除历史热更记录\r\n                                if (!!removePaths) {\r\n                                    let arr = JSON.parse(removePaths);\r\n                                    for (let i in arr) {\r\n                                        log.info('hotUpdate : remove {}', arr[i]);\r\n                                        jsb.fileUtils.removeDirectory(arr[i]);\r\n                                    }\r\n                                }\r\n\r\n                                cc.sys.openURL(js.packageUrl + Checker.URL);\r\n                                cc.game.end();\r\n                            },\r\n                            noCB: function () {\r\n                                cc.game.end();\r\n                            }\r\n                        });\r\n                }\r\n\r\n                if (callback) {\r\n                    callback(localBigVer >= remoteBigVer);\r\n                }\r\n            } else {\r\n                log.info('getVersion failed!')\r\n            }\r\n        });\r\n    });\r\n};\r\n\r\nmodule.exports = Checker;"]}