{"version":3,"sources":["..\\..\\..\\..\\..\\..\\assets\\script\\framework\\hotupdate/assets\\script\\framework\\hotupdate\\HotUpdate.js"],"names":["i18n","require","cc","Class","Component","properties","skip","updatePanel","type","Node","displayName","tooltip","percent","default","Label","progressBar","ProgressBar","checkCb","event","self","log","info","getEventCode","jsb","EventAssetsManager","ERROR_NO_LOCAL_MANIFEST","t","eventManager","removeListener","_checkListener","ERROR_DOWNLOAD_MANIFEST","ERROR_PARSE_MANIFEST","ALREADY_UP_TO_DATE","setTimeout","doLogin","NEW_VERSION_FOUND","_needUpdate","active","string","progress","hotUpdate","updateCb","needRestart","failed","UPDATE_PROGRESSION","getPercent","percentByFile","getPercentByFile","clampf","msg","getMessage","str","toFixed","Math","max","UPDATE_FINISHED","UPDATE_FAILED","_failCount","_am","downloadFailedAssets","ERROR_UPDATING","errstr","getAssetId","ERROR_DECOMPRESS","_updateListener","searchPaths","sys","localStorage","getItem","fileUtils","getSearchPaths","JSON","parse","setItem","stringify","localManifest","getLocalManifest","newPaths","Array","prototype","unshift","setSearchPaths","stopMusic","game","restart","EventListenerAssetsManager","bind","addListener","update","onLoad","start","checkNetWork","Types","MessageBoxType","select","os","OS_ANDROID","initGame","init","sVer","now","Date","loginLayer","getComponent","initComplete","isNative","check","manifestUrl","ret","createUpdater","storagePath","getWritablePath","AssetsManager","nativeUrl","retain","isLoaded","checkUpdate","onDestroy","ENABLE_GC_FOR_NATIVE_OBJECTS","release"],"mappings":"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","file":"HotUpdate.js","sourceRoot":"..\\..\\..\\..\\..\\..\\assets\\script\\framework\\hotupdate","sourcesContent":["'use strict';\r\n\r\nvar i18n = require('LanguageData');\r\n\r\ncc.Class({\r\n    'extends': cc.Component,\r\n\r\n    properties: {\r\n        skip: true,\r\n        \r\n        updatePanel: {\r\n            'default': null,\r\n            type: cc.Node,\r\n            displayName: \"热更新Node\",\r\n            tooltip: \"热更新脚本\"\r\n        },\r\n\r\n        percent: {\r\n            default: null,\r\n            type: cc.Label,\r\n            displayName: \"百分比Label\",\r\n            tooltip: \"百分比\"\r\n        },\r\n\r\n        progressBar: {\r\n            default: null,\r\n            type: cc.ProgressBar,\r\n            displayName: \"进度条Progress\",\r\n            tooltip: \"进度条\"\r\n        },\r\n    },\r\n\r\n    checkCb: function checkCb(event) {\r\n        var self = this;\r\n        log.info('Code: ' + event.getEventCode());\r\n        switch (event.getEventCode()) {\r\n            case jsb.EventAssetsManager.ERROR_NO_LOCAL_MANIFEST:\r\n                log.info(i18n.t(14));\r\n                cc.eventManager.removeListener(this._checkListener);\r\n                break;\r\n            case jsb.EventAssetsManager.ERROR_DOWNLOAD_MANIFEST:\r\n            case jsb.EventAssetsManager.ERROR_PARSE_MANIFEST:\r\n                log.info(i18n.t(13));\r\n                cc.eventManager.removeListener(this._checkListener);\r\n                break;\r\n            case jsb.EventAssetsManager.ALREADY_UP_TO_DATE:\r\n                log.info(i18n.t(12));\r\n                cc.eventManager.removeListener(this._checkListener);\r\n                setTimeout(function () {\r\n                    self.doLogin();\r\n                }, 0);\r\n                break;\r\n            case jsb.EventAssetsManager.NEW_VERSION_FOUND:\r\n                this._needUpdate = true;\r\n                this.updatePanel.active = true;\r\n                this.percent.string = '00.00%';\r\n                this.progressBar.progress = 0;\r\n                cc.eventManager.removeListener(this._checkListener);\r\n                setTimeout(function () {\r\n                    self.hotUpdate();\r\n                }, 0);\r\n                break;\r\n            default:\r\n                break;\r\n        }\r\n    },\r\n\r\n    updateCb: function updateCb(event) {\r\n        var needRestart = false;\r\n        var failed = false;\r\n        switch (event.getEventCode()) {\r\n            case jsb.EventAssetsManager.ERROR_NO_LOCAL_MANIFEST:\r\n                log.info(i18n.t(14)); //\"No local manifest file found, hot update skipped.\"\r\n                failed = true;\r\n                break;\r\n            case jsb.EventAssetsManager.UPDATE_PROGRESSION:\r\n                var percent = event.getPercent();\r\n                var percentByFile = event.getPercentByFile();\r\n                percentByFile = cc.clampf(percentByFile, 0, 100);\r\n\r\n                var msg = event.getMessage();\r\n                if (msg) {\r\n                    log.info(msg);\r\n                }\r\n                var str = 'download: ' + (100 * percentByFile).toFixed(2) + '% | install: ' + (100 * percent).toFixed(2) + '%';\r\n                // let str = (100 * percent).toFixed(2) + '%';\r\n                this.percent.string = str;\r\n                this.progressBar.progress = Math.max(percentByFile, percent);\r\n                break;\r\n            case jsb.EventAssetsManager.ERROR_DOWNLOAD_MANIFEST:\r\n            case jsb.EventAssetsManager.ERROR_PARSE_MANIFEST:\r\n                log.info(i18n.t(13)); //\"Fail to download manifest file, hot update skipped.\"\r\n                failed = true;\r\n                break;\r\n            case jsb.EventAssetsManager.ALREADY_UP_TO_DATE:\r\n                log.info(i18n.t(12)); //\"Already up to date with the latest remote version.\"\r\n                failed = true;\r\n                break;\r\n            case jsb.EventAssetsManager.UPDATE_FINISHED:\r\n                log.info(i18n.t(15)); //'Update finished. '\r\n                needRestart = true;\r\n                break;\r\n            case jsb.EventAssetsManager.UPDATE_FAILED:\r\n                log.info(i18n.t(16)); //'Update failed. '\r\n\r\n                this._failCount++;\r\n                if (this._failCount < 5) {\r\n                    log.info('Download failed assets ...');\r\n                    this._am.downloadFailedAssets();\r\n                } else {\r\n                    log.info('Reach maximum fail count, exit update process');\r\n                    this._failCount = 0;\r\n                    failed = true;\r\n                }\r\n                break;\r\n            case jsb.EventAssetsManager.ERROR_UPDATING:\r\n                var errstr = 'Asset update error: ' + event.getAssetId() + ', ' + event.getMessage();\r\n                log.info(errstr);\r\n                //log.info(errstr);\r\n                break;\r\n            case jsb.EventAssetsManager.ERROR_DECOMPRESS:\r\n                log.info(event.getMessage());\r\n                //log.info(event.getMessage());\r\n                break;\r\n            default:\r\n                break;\r\n        }\r\n\r\n        if (failed) {\r\n            cc.eventManager.removeListener(this._updateListener);\r\n            this._updateListener = null;\r\n            this.updatePanel.active = false;\r\n        }\r\n\r\n        if (needRestart) {\r\n            cc.eventManager.removeListener(this._updateListener);\r\n            this._updateListener = null;\r\n            // Prepend the manifest's search path\r\n            var searchPaths = cc.sys.localStorage.getItem('BaseSearchPaths');\r\n            if (!searchPaths) searchPaths = jsb.fileUtils.getSearchPaths(); else searchPaths = JSON.parse(searchPaths);\r\n            // 原始路径\r\n            cc.sys.localStorage.setItem('BaseSearchPaths', JSON.stringify(searchPaths));\r\n\r\n            var localManifest = this._am.getLocalManifest();\r\n            var newPaths = [];\r\n            if (!!localManifest) newPaths = localManifest.getSearchPaths();\r\n\r\n            // 热更路径\r\n            cc.sys.localStorage.setItem('RemotePaths', JSON.stringify(newPaths));\r\n\r\n            // 原始路径+热更路径\r\n            Array.prototype.unshift(searchPaths, newPaths);\r\n            // 全路径\r\n            cc.sys.localStorage.setItem('HotUpdateSearchPaths', JSON.stringify(searchPaths));\r\n            // This value will be retrieved and appended to the default search path during game startup,\r\n            // please refer to samples/js-tests/main.js for detailed usage.\r\n            // !!! Re-add the search paths in main.js is very important, otherwise, new scripts won't take effect.\r\n\r\n            jsb.fileUtils.setSearchPaths(searchPaths);\r\n            setTimeout(function () {\r\n                require('AudioManager').stopMusic();\r\n                cc.game.restart();\r\n            }, 0);\r\n        }\r\n    },\r\n\r\n    hotUpdate: function hotUpdate() {\r\n        if (this._am && this._needUpdate) {\r\n            this._updateListener = new jsb.EventListenerAssetsManager(this._am, this.updateCb.bind(this));\r\n            cc.eventManager.addListener(this._updateListener, 1);\r\n\r\n            this._failCount = 0;\r\n            this._am.update();\r\n        }\r\n    },\r\n\r\n    // use this for initialization\r\n    onLoad() {\r\n        \r\n    },\r\n\r\n    start: function start() {\r\n        log.info('HotUpdate.start: is called');\r\n        // cc._initDebugSetting(cc.DebugMode.INFO);\r\n        var self = this;\r\n\r\n        //check network\r\n        this.checkNetWork();\r\n    },\r\n\r\n    checkNetWork: function checkNetWork() {\r\n        log.info('MessageBoxType.select:' + game.Types.MessageBoxType.select);\r\n        var self = this;\r\n        // if (cc.sys.isNative) {\r\n        if (cc.sys.os == cc.sys.OS_ANDROID) {\r\n            // window.Utility.getNetState(function(state) {\r\n            // if(state == 'NO_INTERNET') {\r\n            //     UIMessageBox.show('','当前网络不可用，请重试！', game.Types.MessageBoxType.select, function() {cc.game.restart()}, function() {cc.game.end()});\r\n            //     return;\r\n            // }\r\n            setTimeout(function () {\r\n                self.initGame();\r\n            }, 0);\r\n            // });\r\n        } else {\r\n            setTimeout(function () {\r\n                self.initGame();\r\n            }, 0);\r\n        }\r\n        // } else {\r\n        //     alert('is not native');\r\n        // }\r\n    },\r\n\r\n    doLogin: function doLogin() {\r\n\r\n    },\r\n\r\n    initGame: function initGame() {\r\n        log.info('start initGame');\r\n\r\n        // 测试多语言\r\n        i18n.init('zh');\r\n        let sVer = i18n.t('jinbi');\r\n        var self = this;\r\n        var now = Date.now();\r\n        require('GameInit').init(() => {\r\n            log.info('GameInit time : ' + (Date.now() - now));\r\n            let loginLayer = self.getComponent('Login');\r\n            if (loginLayer) {\r\n                loginLayer.initComplete();\r\n            }\r\n\r\n            //是否进行热更新检查\r\n            if (!cc.sys.isNative || self.skip) {\r\n                log.info('skip checkVersion');\r\n                // self.doLogin();\r\n                // self.login.active = true;\r\n                // self.updatePanel.active = false;\r\n                return;\r\n            }\r\n            setTimeout(() => {\r\n                require('CheckVersion').check(self.manifestUrl, function (ret) {\r\n                    log.info('CheckVersion status = {}', ret);\r\n                    if (!ret) {\r\n                        // UIMessageBox.show('', '版本检查失败');\r\n                        return;\r\n                    }\r\n                    // Hot update is only available in Native build\r\n                    if (!cc.sys.isNative) {\r\n                        self.doLogin();\r\n                    } else {\r\n                        self.createUpdater();\r\n                    }\r\n                });\r\n            }, 0);\r\n        });\r\n    },\r\n\r\n    createUpdater: function createUpdater() {\r\n        var storagePath = (jsb.fileUtils ? jsb.fileUtils.getWritablePath() : '/') + 'remote-asset';\r\n        log.info('Storage path for remote asset : ' + storagePath);\r\n\r\n        // log.info('Local manifest URL : ' + this.manifestUrl);\r\n        this._am = new jsb.AssetsManager(this.manifestUrl.nativeUrl, storagePath);\r\n        this._am.retain();\r\n\r\n        this._needUpdate = false;\r\n        var localManifest = this._am.getLocalManifest();\r\n        if (!!localManifest && localManifest.isLoaded()) {\r\n            this._checkListener = new jsb.EventListenerAssetsManager(this._am, this.checkCb.bind(this));\r\n            cc.eventManager.addListener(this._checkListener, 1);\r\n            this._am.checkUpdate();\r\n        }\r\n    },\r\n\r\n    onDestroy: function onDestroy() {\r\n        if (this._updateListener) {\r\n            cc.eventManager.removeListener(this._updateListener);\r\n            this._updateListener = null;\r\n        }\r\n        if (this._am && !cc.sys.ENABLE_GC_FOR_NATIVE_OBJECTS) {\r\n            this._am.release();\r\n        }\r\n    }\r\n});"]}