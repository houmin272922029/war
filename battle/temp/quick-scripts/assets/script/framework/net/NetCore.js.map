{"version":3,"sources":["NetCore.js"],"names":["root","NetCore","obj","window","OPEN","CLOSE","ERROR","contentStatus","onConnected","undefined","onMsgIn","onError","onClosed","onReconnectFailed","ReconnectMaxTimes","ReconnectInterval","ReconnectTimes","isReconnect","canReconnnet","reconnetID","init","callback","deserializeMsg","buf","id","msg","Id","Data","subarray","serializeMsg","data","Uint8Array","length","set","ws","send","buffer","Connect","url","_this","log","info","cc","sys","isObjectValid","readyState","WebSocket","onopen","event","clearInterval","onmessage","received","CC_WECHATGAME","isNative","reader","FileReader","readAsArrayBuffer","onload","e","result","onclose","onerror","Reconnect","setInterval","disConnect","close","sendMessage","setTimeout","error","warn","call"],"mappings":"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","file":"NetCore.js","sourceRoot":"..\\..\\..\\..\\..\\..\\assets\\script\\framework\\net","sourcesContent":["\"use strict\";\r\n\r\n(function () {\r\n\r\n    var root = this;\r\n    var NetCore = function NetCore(obj) {\r\n        if (obj instanceof NetCore) return NetCore;\r\n        if (!(this instanceof NetCore)) return new NetCore(obj);\r\n    };\r\n\r\n    // if (typeof exports !== 'undefined') {\r\n    //     if (typeof module !== 'undefined' && module.exports) {\r\n    //         exports = module.exports = NetCore;\r\n    //     }\r\n    //     exports.NetCore = NetCore;\r\n    // } else {\r\n    //     root.NetCore = NetCore;\r\n    // }\r\n\r\n    window.NetCore = NetCore;\r\n\r\n    NetCore.OPEN = -1;\r\n    NetCore.CLOSE = -2;\r\n    NetCore.ERROR = -3;\r\n    NetCore.contentStatus = -1;//连接状态\r\n    NetCore.onConnected = undefined;\r\n    NetCore.onMsgIn = undefined;\r\n    NetCore.onError = undefined;\r\n    NetCore.onClosed = undefined;\r\n    NetCore.onReconnectFailed = undefined;\r\n\r\n    NetCore.ReconnectMaxTimes = 4;     // 最大重连次数 多出来一次，如果最后一次开始重连时还没有连上就关闭\r\n    NetCore.ReconnectInterval = 5;      // 重连间隔/s\r\n    NetCore.ReconnectTimes = 4;        // 剩余重连次数\r\n    NetCore.isReconnect = false;       //是否是断线重连上的\r\n    NetCore.canReconnnet = true;       //是否能断线重连\r\n    NetCore.reconnetID = -1;           //重连timeid\r\n    /** \r\n     * 初始化网络库\r\n     * @param {*初始化成功回调函数} callback \r\n     */\r\n    NetCore.init = function (callback) {\r\n        if (callback) {\r\n            callback();\r\n        }\r\n    };\r\n\r\n    // 反序列化数据\r\n    NetCore.deserializeMsg = function (buf) {\r\n        var id = 0;\r\n        id += (buf[0] & 0x000000ff) << 24;\r\n        id += (buf[1] & 0x000000ff) << 16;\r\n        id += (buf[2] & 0x000000ff) << 8;\r\n        id += buf[3] & 0x000000ff;\r\n        var msg = { Id: id, Data: buf.subarray(4) };\r\n        this.onMsgIn && this.onMsgIn(msg);\r\n    }\r\n\r\n    // 序列化数据\r\n    NetCore.serializeMsg = function (id, data) {\r\n        var buf = new Uint8Array(data.length + 4);\r\n        buf[0] = id >> 24 & 0xff;\r\n        buf[1] = id >> 16 & 0xff;\r\n        buf[2] = id >> 8 & 0xff;\r\n        buf[3] = id & 0xff;\r\n        buf.set(data, 4);\r\n        this.ws.send(buf.buffer);\r\n    }\r\n\r\n    /**\r\n     * 建立websocket连接\r\n     * @param {*连接地址} url \r\n     * @param {*连接成功回调} onConnected \r\n     * @param {*收到消息回调} onMsgIn \r\n     * @param {*连接失败回调} onError \r\n     * @param {*连接断开回调} onClosed \r\n     */\r\n    NetCore.Connect = function (url, onConnected, onMsgIn, onError, onClosed, onReconnectFailed) {\r\n        var _this = this;\r\n        NetCore.contentStatus = 0;\r\n        this.onConnected = onConnected;\r\n        this.onMsgIn = onMsgIn;\r\n        this.onError = onError;\r\n        this.onClosed = onClosed;\r\n        this.onReconnectFailed = onReconnectFailed;\r\n\r\n        log.info(\"NetCore: trying to connect server {} \", url);\r\n        if (cc.sys.isObjectValid(this.ws)) {\r\n            if (this.ws.readyState < 2) {\r\n                cc.log('有链接正在进行，请稍等！');\r\n                return;\r\n            }\r\n        }\r\n        this.ws = new WebSocket(url);\r\n\r\n        this.url = url;\r\n\r\n        this.ws.onopen = function (event) {\r\n            log.info('NetCore: websocket onopen.  {}', event);\r\n            clearInterval(NetCore.reconnetID);\r\n            var msg = { Id: _this.OPEN };\r\n            if (!!NetCore.onConnected) {\r\n                NetCore.onConnected(msg);\r\n            }\r\n            NetCore.contentStatus = 1;\r\n            // 重置重连次数\r\n            NetCore.ReconnectTimes = 0;\r\n            NetCore.isReconnect = false;\r\n        };\r\n\r\n        this.ws.onmessage = (received) => {\r\n            if (CC_WECHATGAME) {\r\n                this.deserializeMsg(new Uint8Array(received.data));\r\n            } else if (!cc.sys.isNative) {\r\n                (() => {\r\n                    var reader = new FileReader();\r\n                    reader.readAsArrayBuffer(received.data);\r\n                    reader.onload = (e) => {\r\n                        this.deserializeMsg(new Uint8Array(reader.result));\r\n                    }\r\n                })();\r\n            } else {\r\n                this.deserializeMsg(new Uint8Array(received.data));\r\n            }\r\n        };\r\n\r\n        this.ws.onclose = function (event) {\r\n            log.info('NetCore: websocket onclose: {}, reconnect: {}', event, NetCore.ReconnectTimes);\r\n            var msg = { Id: _this.CLOSE };\r\n            if (!!NetCore.onClosed && NetCore.contentStatus === -1) {\r\n                if (NetCore.ReconnectTimes < 0) {\r\n                    // -1 : 重连超时\r\n                    NetCore.ReconnectTimes = 0;\r\n                    if (NetCore.onReconnectFailed) NetCore.onReconnectFailed();\r\n                } else {\r\n                    NetCore.onClosed(msg);\r\n                }\r\n            }\r\n            NetCore.contentStatus = -1;\r\n        };\r\n\r\n        this.ws.onerror = function (event) {\r\n            log.info('NetCore: websocket onerror :', event);\r\n            var msg = { Id: _this.ERROR };\r\n            if (!!NetCore.onError) {\r\n                NetCore.onError(msg);\r\n            }\r\n            NetCore.contentStatus = -1;\r\n            // NetCore.isReconnect = false;\r\n        };\r\n    };\r\n\r\n    NetCore.readyState = function () {\r\n        if (!!this.ws) {\r\n            return this.ws.readyState;\r\n        }\r\n        return 0;\r\n    };\r\n    /**\r\n     * 重新建立连接\r\n     */\r\n    NetCore.Reconnect = function () {\r\n        log.info('NetCore Reconnect times = {}', NetCore.ReconnectTimes);\r\n        if (NetCore.ReconnectTimes > 0) {\r\n            (function () {\r\n                // 每5秒重试一次\r\n                NetCore.reconnetID = setInterval(function () {\r\n                    cc.log('尝试重连+++', NetCore.reconnetID);\r\n                    NetCore.disConnect();\r\n                    --NetCore.ReconnectTimes;\r\n                    if (0 == NetCore.ReconnectTimes) {\r\n                        // 重连超时\r\n                        NetCore.ReconnectTimes = -1;\r\n                        clearInterval(NetCore.reconnetID);\r\n                        NetCore.ReconnectTimes = 0;\r\n                        if (NetCore.onReconnectFailed) NetCore.onReconnectFailed();\r\n                    } else {\r\n                        NetCore.isReconnect = true;\r\n                        NetCore.Connect(NetCore.url, NetCore.onConnected, NetCore.onMsgIn, NetCore.onError, NetCore.onClosed, NetCore.onReconnectFailed);\r\n                    }\r\n                }, NetCore.ReconnectInterval * 1000);\r\n            })();\r\n        }\r\n    };\r\n\r\n    /**\r\n     * 断开连接\r\n     */\r\n    NetCore.disConnect = function () {\r\n        log.info('NetCore disConnect!');\r\n        if (cc.sys.isObjectValid(this.ws)) {\r\n            this.ws.close();\r\n            this.ws.onclose = null;\r\n            delete this.ws;\r\n            this.ws = null;\r\n            cc.log('disconnet+++++')\r\n        }\r\n        NetCore.contentStatus = -1;\r\n        NetCore.isReconnect = false;\r\n    };\r\n\r\n    /**\r\n     * 发送消息\r\n     * @param {*消息头} id \r\n     * @param {*消息体} data \r\n     */\r\n    NetCore.sendMessage = function (id, data) {\r\n        if (cc.sys.isObjectValid(this.ws) && this.ws.readyState == WebSocket.OPEN) {\r\n            this.serializeMsg(id, data);\r\n        } else {\r\n            setTimeout(function () {\r\n                NetCore.sendMessage(id, data);\r\n            }, 500);\r\n            if (cc.sys.isObjectValid(this.ws)) {\r\n                log.error('NetCore: SendMsg error readState:' + this.ws.readyState);\r\n            } else {\r\n                log.warn('NetCore: SendMsg error ws is null');\r\n            }\r\n        }\r\n    };\r\n}).call(this);"]}